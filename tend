#!/usr/bin/bash
if [ "$#" -eq "0" ]; then
    echo "--tend--"
    echo "    tend command [arguments, ...]"
    echo "commands:"
    echo "    le - list all entities"
    echo "    le [id]"
    echo "    la - list all aliases for an entity"
    echo "    la [entity id]"
    echo "    ls - list all snippets for an entity"
    echo "    ls [entity id]"
    echo "    fa - find an entity by alias"
    echo "    fa [name]"
    echo "    ae - add an entity"
    echo "    ae [name]"
    echo "    aa - add an alias to an entity"
    echo "    aa [id] [name]"
    echo "    as - add snippet to an entity"
    echo "    as [id]"
else
    case $1 in
        "le")
            echo "--list all entities--"
            if [ "$#" -eq "2" ]; then
                psql -d tend -c "select * from entity where id = ${2};"
            else
                psql -d tend -c "select * from entity;"
            fi
            ;;
        "la")
            echo "--list all aliases--"
            if [ "$#" -eq "2" ]; then
                entity_id="$2"
            else
                printf "enter entity id:"
                read -r entity_id
            fi
            psql -d tend -c "select name, updated from alias where entity_id = ${entity_id};"
            ;;
        "ls")
            echo "--list all snippets--"
            if [ "$#" -eq "2" ]; then
                entity_id="$2"
            else
                printf "enter entity id:"
                read -r entity_id
            fi
            psql -d tend -c "select data, updated from snippet where entity_id = ${entity_id};"
            ;;
        "fa")
            echo "--find entity--"
            if [ "$#" -eq "2" ]; then
                name="$2"
            else
                printf "enter name:"
                read -r name
            fi
            psql -d tend -c "select name, entity_id, updated from alias where name like '%${name}%';"
            ;;
        "ae")
            echo "--add entity--"
            if [ "$#" -eq "2" ]; then
                name="$2"
            else
                printf "enter name:"
                read -r name
            fi
            psql -d tend -c "insert into entity default values;
                            insert into alias (name, entity_id) values ('${name}', lastval());"
            ;;
        "aa")
            echo "--add alias--"
            if [ "$#" -eq "3" ]; then
                id="$2"
                name="$3"
            elif [ "$#" -eq "2" ]; then
                id="$2"
                printf "enter name:"
                read -r name
            else
                printf "enter id:"
                read -r id
                printf "enter name:"
                read -r name
            fi
            psql -d tend -c "insert into alias (name, entity_id) values ('${name}', ${id});"
            ;;
        "as")
            echo "--add snippet--"
            if [ "$#" -eq "2" ]; then
                id="$2"
            else
                printf "enter id:"
                read -r id
            fi
            #no this isnt security yes i know you can do sql injections here (youre running this locally you have a damn shell)
            #this this is because i dont want to have to sanitize it manually if i want to say shove json into the db
            data=$(sed -r "s/'/\\\\'/g" </dev/stdin)
            psql -d tend -c "insert into snippet (data,entity_id) values ('${data}', ${id});"
            ;;
        *)
            echo "unknown option $1"
            $0
            ;;
    esac
fi
